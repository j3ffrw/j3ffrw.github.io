<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="core">
<meta name="description"
    content="# lm_sensor UserParameter=sensors[*],/usr/local/bin/sensors | grep &amp;#34;$1&amp;#34; | head -$2 | tail -1 | awk &amp;#34;{print $&amp;#34;$3&amp;#34;}&amp;#34; | sed &amp;#39;s/[-!@#\$%^&amp;amp;*()째&#43;a-zA-Z]//g&amp;#39; # SMARTD UserParameter=system.smartd[*],sudo smartctl -A $1 | grep $2 | tail -1 | cut -c 88- | cut -f1 -d&amp;#39; &amp;#39; # NUT UserParameter=nut[*],/ups/bin/upsc myups@192.168.1.18 $1 # SpiderOak size UserParameter=spideroak.size,/etc/zabbix/spideroak # md5sum whole folder UserParameter=vfs.folder.md5sum[*],find $1 -xtype f -print0 | xargs -0 md5sum | tee /tmp/$2.md5 | cut -b-32 | md5sum | cut -b-32 SpiderOak script" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/p432/" />


<title>
    
    Custom zabbix user parameters and jabber script :: Tech notes and other stuff 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.d90905eb29b71569a516566cd9662312bee9ab021c760de6949cdc92d6688be9.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="Custom zabbix user parameters and jabber script">
<meta itemprop="description" content="# lm_sensor UserParameter=sensors[*],/usr/local/bin/sensors | grep &#34;$1&#34; | head -$2 | tail -1 | awk &#34;{print $&#34;$3&#34;}&#34; | sed &#39;s/[-!@#\$%^&amp;*()째&#43;a-zA-Z]//g&#39; # SMARTD UserParameter=system.smartd[*],sudo smartctl -A $1 | grep $2 | tail -1 | cut -c 88- | cut -f1 -d&#39; &#39; # NUT UserParameter=nut[*],/ups/bin/upsc myups@192.168.1.18 $1 # SpiderOak size UserParameter=spideroak.size,/etc/zabbix/spideroak # md5sum whole folder UserParameter=vfs.folder.md5sum[*],find $1 -xtype f -print0 | xargs -0 md5sum | tee /tmp/$2.md5 | cut -b-32 | md5sum | cut -b-32 SpiderOak script">


<meta itemprop="datePublished" content="2013-06-06T03:24:23&#43;00:00" />
<meta itemprop="dateModified" content="2013-06-06T03:24:23&#43;00:00" />
<meta itemprop="wordCount" content="348">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Custom zabbix user parameters and jabber script"/>
<meta name="twitter:description" content="# lm_sensor UserParameter=sensors[*],/usr/local/bin/sensors | grep &#34;$1&#34; | head -$2 | tail -1 | awk &#34;{print $&#34;$3&#34;}&#34; | sed &#39;s/[-!@#\$%^&amp;*()째&#43;a-zA-Z]//g&#39; # SMARTD UserParameter=system.smartd[*],sudo smartctl -A $1 | grep $2 | tail -1 | cut -c 88- | cut -f1 -d&#39; &#39; # NUT UserParameter=nut[*],/ups/bin/upsc myups@192.168.1.18 $1 # SpiderOak size UserParameter=spideroak.size,/etc/zabbix/spideroak # md5sum whole folder UserParameter=vfs.folder.md5sum[*],find $1 -xtype f -print0 | xargs -0 md5sum | tee /tmp/$2.md5 | cut -b-32 | md5sum | cut -b-32 SpiderOak script"/>



<meta property="article:section" content="Linux" />

<meta property="article:published_time" content="2013-06-06 03:24:23 &#43;0000 &#43;0000" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">hello world</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about">About</a></li><li><a href="/posts">Blog</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/p432/">Custom zabbix user parameters and jabber script</a></h2>

            

            <div class="post-content">
                <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># lm_sensor</span>
UserParameter<span style="color:#f92672">=</span>sensors<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>,/usr/local/bin/sensors | grep <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> | head -$2 | tail -1 | awk <span style="color:#e6db74">&#34;{print </span>$<span style="color:#e6db74">&#34;</span>$3<span style="color:#e6db74">&#34;}&#34;</span> | sed <span style="color:#e6db74">&#39;s/[-!@#\$%^&amp;*()째+a-zA-Z]//g&#39;</span>

<span style="color:#75715e"># SMARTD</span>
UserParameter<span style="color:#f92672">=</span>system.smartd<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>,sudo smartctl -A $1 | grep $2 | tail -1 | cut -c <span style="color:#ae81ff">88</span>- | cut -f1 -d<span style="color:#e6db74">&#39; &#39;</span>

<span style="color:#75715e"># NUT</span>
UserParameter<span style="color:#f92672">=</span>nut<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>,/ups/bin/upsc myups@192.168.1.18 $1

<span style="color:#75715e"># SpiderOak size</span>
UserParameter<span style="color:#f92672">=</span>spideroak.size,/etc/zabbix/spideroak

<span style="color:#75715e"># md5sum whole folder</span>
UserParameter<span style="color:#f92672">=</span>vfs.folder.md5sum<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>,find $1 -xtype f -print0 | xargs -0 md5sum | tee /tmp/$2.md5 | cut -b-32 | md5sum | cut -b-32</code></pre></div>

<p>SpiderOak script</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>HOME<span style="color:#f92672">=</span>/home/zabbix
export HOME

/usr/bin/SpiderOak --space | grep <span style="color:#e6db74">&#34;Space usage by device&#34;</span> | head -<span style="color:#e6db74">&#34;1&#34;</span> | tail -1 | awk <span style="color:#e6db74">&#34;{print </span>$<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">6</span><span style="color:#e6db74">&#34;}&#34;</span> | sed <span style="color:#e6db74">&#39;s/[,]//g&#39;</span></code></pre></div>

<p>To allow zabbix user to run commands make the ff changes in sudoers</p>

<pre><code>#Defaults    requiretty
Defaults:zabbix !requiretty
</code></pre>

<p>and add the ff.</p>

<pre><code># Cmnd alias specification
Cmnd_Alias ZABBIXCMD = /sbin/mdadm --detail *
# ZABBIX special privileges
zabbix ALL=NOPASSWD: ZABBIXCMD
zabbix ALL=NOPASSWD: /usr/sbin/smartctl
#zabbix ALL=NOPASSWD: /usr/bin/SpiderOak
</code></pre>

<p>Send notification via jabber using the ff. perl script.</p>

<p>put this script on the zabbix conf folder (/etc/zabbix)</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>
<span style="color:#75715e"># from http://mail.jabber.org/pipermail/jadmin/attachments/20021021/cccbf59d/jbline-0003.obj</span>
<span style="color:#66d9ef">use</span> strict;
<span style="color:#66d9ef">use</span> Net::Jabber <span style="color:#e6db74">qw( Client )</span>;
<span style="color:#66d9ef">use</span> constant SERVER	<span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;192.168.4.2&#39;</span>;
<span style="color:#66d9ef">use</span> constant PORT	<span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">5222</span>; <span style="color:#75715e"># Port to connect to</span>
<span style="color:#66d9ef">use</span> constant USER	<span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;automonitor&#39;</span>;
<span style="color:#66d9ef">use</span> constant PASSWORD	<span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;BdgSte2378&#39;</span>;
<span style="color:#66d9ef">use</span> constant RESOURCE	<span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;perlscript&#39;</span>;

<span style="color:#66d9ef">my</span> $connection <span style="color:#f92672">=</span> Net::Jabber::Client<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>();
$connection<span style="color:#f92672">-&gt;</span>Connect( <span style="color:#e6db74">&#34;hostname&#34;</span> <span style="color:#f92672">=&gt;</span> SERVER,
		      <span style="color:#e6db74">&#34;port&#34;</span>   	 <span style="color:#f92672">=&gt;</span> PORT )
	<span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Cannot connect ($!)\n&#34;</span>;

<span style="color:#66d9ef">my</span> @result <span style="color:#f92672">=</span> $connection<span style="color:#f92672">-&gt;</span>AuthSend( <span style="color:#e6db74">&#34;username&#34;</span> <span style="color:#f92672">=&gt;</span> USER,
				    <span style="color:#e6db74">&#34;password&#34;</span> <span style="color:#f92672">=&gt;</span> PASSWORD,
				    <span style="color:#e6db74">&#34;resource&#34;</span> <span style="color:#f92672">=&gt;</span> RESOURCE );
<span style="color:#66d9ef">if</span> ($result[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">ne</span> <span style="color:#e6db74">&#34;ok&#34;</span>) {
	die <span style="color:#e6db74">&#34;Ident/Auth with server failed: $result[0] - $result[1]\n&#34;</span>;
}

<span style="color:#66d9ef">my</span> $date <span style="color:#f92672">=</span> dtg(time);
<span style="color:#66d9ef">my</span> $bbmessage <span style="color:#f92672">=</span> $ARGV[<span style="color:#ae81ff">2</span>];
<span style="color:#66d9ef">my</span> $bbsubject <span style="color:#f92672">=</span> $ARGV[<span style="color:#ae81ff">1</span>];
<span style="color:#66d9ef">my</span> $bbrecipient <span style="color:#f92672">=</span> $ARGV[<span style="color:#ae81ff">0</span>];
<span style="color:#66d9ef">my</span> $msg <span style="color:#f92672">=</span> Net::Jabber::Message<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>();
$msg<span style="color:#f92672">-&gt;</span>SetMessage( <span style="color:#e6db74">&#34;to&#34;</span>		<span style="color:#f92672">=&gt;</span> $bbrecipient,
		  <span style="color:#e6db74">&#34;body&#34;</span>	<span style="color:#f92672">=&gt;</span> join(<span style="color:#e6db74">&#34;\n&#34;</span>,<span style="color:#e6db74">&#34;$bbsubject&#34;</span>,<span style="color:#e6db74">&#34;$bbmessage&#34;</span>) );
$msg<span style="color:#f92672">-&gt;</span>SetType(<span style="color:#e6db74">&#34;chat&#34;</span>);

$connection<span style="color:#f92672">-&gt;</span>Send($msg);
$connection<span style="color:#f92672">-&gt;</span>Disconnect();
exit;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">dtg</span> {
	<span style="color:#66d9ef">my</span> ($string) <span style="color:#f92672">=</span> @_;
	<span style="color:#66d9ef">my</span> ($time_str);
	$time_str <span style="color:#f92672">=</span> localtime($string);
	<span style="color:#66d9ef">return</span> substr($time_str,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">15</span>);
}</code></pre></div>

<p>Create a new media type in Zabbix</p>

<figure >
  



























<img 
  sizes="(min-width: 35em) 1200px, 100vw"
  srcset='
  
  
  
  '
  
    src="/p432/Selection_007.png" 
  
  alt="">


    <figcaption>
      <p></p>
  </figcaption>
</figure>


<p>Add the media type to a particular user for him to receive notifications via jabber.</p>




























<img 
  sizes="(min-width: 35em) 1200px, 100vw"
  srcset='
  
  
  
  '
  
    src="/p432/Selection_008.png" 
  
  alt="">


<p>minimal zabbix proxy config</p>

<pre><code>Server=&lt;IP_ADDRESS&gt;
Hostname=&lt;ZABBIX_PROXY_UNIQUE_NAME&gt;
LogFile=/tmp/zabbix_proxy.log
DBName=zabbix
DBUser=zabbix
DBPassword=&lt;DB_PASSWORD&gt;
ProxyLocalBuffer=24
ProxyOfflineBuffer=720
ConfigFrequency=3600
</code></pre>

<p>minimal zabbix server config</p>

<pre><code>NodeID=1
# ListenPort=10051
LogFile=/tmp/zabbix_server.log
PidFile=/tmp/zabbix_server.pid
# DBHost=localhost
DBName=zabbix
DBUser=zabbix
DBPassword=dBfA9bat7SUrT3GS
StartPollers=10
# ListenIP=0.0.0.0
AlertScriptsPath=/etc/zabbix
</code></pre>

            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span></span>
            <span> <a href="posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.9e52e68b082cf2a30a7fead88260edb8818fbd7f7831e39674917d4539ec75df41ba88eaddfbd916594ab4fb2a31913b46cf2d6094cf80381edb8c632512a8ca.js" integrity="sha512-nlLmiwgs8qMKf&#43;rYgmDtuIGPvX94MeOWdJF9RTnsdd9Buojq3fvZFllKtPsqMZE7Rs8tYJTPgDge24xjJRKoyg=="></script>



    </body>
</html>
